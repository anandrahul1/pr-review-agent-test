name: Auto PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install agentcore CLI
        run: pip install bedrock-agentcore

      - name: Invoke PR Review Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          repo="${{ github.repository }}"
          pr_number="${{ github.event.pull_request.number }}"
          runtime_arn="arn:aws:bedrock-agentcore:us-east-1:216989103085:runtime/prreviewagent-0wXytaGYLt"
          
          # Configure agentcore CLI
          agentcore configure -r "$runtime_arn"
          
          # Invoke agent
          agentcore invoke "{
            \"jsonrpc\": \"2.0\",
            \"id\": \"pr-${pr_number}-auto\",
            \"method\": \"message/send\",
            \"params\": {
              \"message\": {
                \"role\": \"user\",
                \"parts\": [{
                  \"kind\": \"text\",
                  \"text\": \"Review PR #${pr_number} in ${repo}\"
                }],
                \"messageId\": \"pr-${pr_number}-auto\"
              }
            }
          }" && echo "‚úÖ Agent invoked for PR #${pr_number}" || echo "‚ö†Ô∏è Invocation failed"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ PR Review Agent triggered! Analysis in progress...'
            })
